From 6d6424fffdd3e1b71521d115f81fec7850c77f7d Mon Sep 17 00:00:00 2001
From: Alexandre Jutras <alexandre.jutras@nxp.com>
Date: Thu, 18 Jul 2019 13:47:47 -0400
Subject: [PATCH 2/2] [Hack] Do not send file descriptor for non-secure content

Signed-off-by: Alexandre Jutras <alexandre.jutras@nxp.com>
---
 src/com/common/socket/socket_client_helper.cpp         | 5 +++++
 src/com/mediaengine/rpc/rpc_cdm_mediaengine_handler.cc | 7 +++++++
 2 files changed, 12 insertions(+)

diff --git a/src/com/common/socket/socket_client_helper.cpp b/src/com/common/socket/socket_client_helper.cpp
index 2de93e8..4228025 100644
--- a/src/com/common/socket/socket_client_helper.cpp
+++ b/src/com/common/socket/socket_client_helper.cpp
@@ -131,6 +131,11 @@ int SocketClient::SendFileDescriptor(int f_FileDescriptor, uint32_t f_Size)
   cmsg->cmsg_type = SCM_RIGHTS;
   *(int *)CMSG_DATA(cmsg) = f_FileDescriptor;
 
+  if(f_FileDescriptor < 0) {
+    msg.msg_control = NULL;
+    msg.msg_controllen = 0;
+  }
+
   status = sendmsg(m_SocketFd, &msg, 0);
   if(status >= 0) {
     status = 0;  // Success
diff --git a/src/com/mediaengine/rpc/rpc_cdm_mediaengine_handler.cc b/src/com/mediaengine/rpc/rpc_cdm_mediaengine_handler.cc
index 9955f74..d28c197 100644
--- a/src/com/mediaengine/rpc/rpc_cdm_mediaengine_handler.cc
+++ b/src/com/mediaengine/rpc/rpc_cdm_mediaengine_handler.cc
@@ -187,6 +187,13 @@ DecryptResponse RpcCdmMediaengineHandler::Decrypt(const uint8_t *pbIv,
     return response;
   }   
   pOutputInfo = (OutputInfo *)out;
+  
+  if(pOutputInfo->size < cbData) {
+    CDM_DLOG() << "Output buffer is too small (cbData: " << cbData << ", output size: " << pOutputInfo->size << ").";
+    response.platform_response = PLATFORM_CALL_FAIL;
+    out_size = 0;
+    return response;
+  } 
 #else
    if(out_size < cbData) {
     CDM_DLOG() << "Output buffer is too small (cbData: " << cbData << ", out_size: " << out_size << ").";
-- 
2.7.4

