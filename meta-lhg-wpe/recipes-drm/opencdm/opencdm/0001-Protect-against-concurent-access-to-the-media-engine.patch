From a11df9026c51a5952b5a22ce7285147c3c0a52e5 Mon Sep 17 00:00:00 2001
From: Alexandre Jutras <alexandre.jutras@nxp.com>
Date: Thu, 4 Jul 2019 16:23:01 -0400
Subject: [PATCH] Protect against concurent access to the media engine

Signed-off-by: Alexandre Jutras <alexandre.jutras@nxp.com>
---
 src/browser/wpe/opencdm/open_cdm.cpp | 3 +++
 src/browser/wpe/opencdm/open_cdm.h   | 1 +
 2 files changed, 4 insertions(+)

diff --git a/src/browser/wpe/opencdm/open_cdm.cpp b/src/browser/wpe/opencdm/open_cdm.cpp
index fa94e37..86d8441 100644
--- a/src/browser/wpe/opencdm/open_cdm.cpp
+++ b/src/browser/wpe/opencdm/open_cdm.cpp
@@ -242,6 +242,8 @@ int OpenCdm::Close() {
 }
 
 int OpenCdm::ReleaseMem() {
+  std::unique_lock<std::mutex> lck(m_decrypt_mtx);
+
   if(media_engine_)
      return media_engine_->ReleaseMem();
 
@@ -253,6 +255,7 @@ int OpenCdm::Decrypt(unsigned char* encryptedData, uint32_t encryptedDataLength,
   int ret = 1;
   uint8_t *out = NULL;
   uint32_t out_size = 0;
+  std::unique_lock<std::mutex> lck(m_decrypt_mtx);
 
   CDM_DLOG() << "OpenCdm::Decrypt session_id : " << m_session_id.session_id << endl;
   CDM_DLOG() << "OpenCdm::Decrypt session_id_len : " << m_session_id.session_id_len << endl;
diff --git a/src/browser/wpe/opencdm/open_cdm.h b/src/browser/wpe/opencdm/open_cdm.h
index 718c05e..f6eb43d 100644
--- a/src/browser/wpe/opencdm/open_cdm.h
+++ b/src/browser/wpe/opencdm/open_cdm.h
@@ -83,6 +83,7 @@ private:
 
   std::string m_key_system;
   std::mutex  m_mtx;
+  std::mutex  m_decrypt_mtx;
   std::string m_message;
   std::string m_dest_url;
 
-- 
2.7.4

